<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html"><meta property="og:site_name" content="阿Q说代码"><meta property="og:title" content="InnoDB 的锁和 MVCC"><meta property="og:description" content="最近要在公司内做一次技术分享，思来想去不知道该分享些什么，最后在朋友的提示下，准备分享一下MySQL的`InnoDB引擎下的事务幻读问题与解决方案--LBCC&MVCC。经过好几天的熬夜通宵，终于把这部分的内容捋清楚了。至于为什么说是InnoDB呢？因为MyISAM引擎是不支持事务的。 事务 概念 一个事情由n个单元组成，这n个单元在执行过程中，要么同..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-04-04T01:24:17.000Z"><meta property="article:author" content="阿Q"><meta property="article:tag" content="事务"><meta property="article:tag" content="LBCC"><meta property="article:tag" content="MVCC"><meta property="article:modified_time" content="2023-04-04T01:24:17.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"InnoDB 的锁和 MVCC","image":[""],"dateModified":"2023-04-04T01:24:17.000Z","author":[{"@type":"Person","name":"阿Q","url":"https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI5MDg2NjEzNA==#wechat_redirect"}]}</script><title>InnoDB 的锁和 MVCC | 阿Q说代码</title><meta name="description" content="最近要在公司内做一次技术分享，思来想去不知道该分享些什么，最后在朋友的提示下，准备分享一下MySQL的`InnoDB引擎下的事务幻读问题与解决方案--LBCC&MVCC。经过好几天的熬夜通宵，终于把这部分的内容捋清楚了。至于为什么说是InnoDB呢？因为MyISAM引擎是不支持事务的。 事务 概念 一个事情由n个单元组成，这n个单元在执行过程中，要么同...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-2bb237ea.css" as="style"><link rel="stylesheet" href="/assets/style-2bb237ea.css">
    <link rel="modulepreload" href="/assets/app-9ac075de.js"><link rel="modulepreload" href="/assets/framework-a9f5de78.js"><link rel="modulepreload" href="/assets/InnoDB 的锁和 MVCC.html-d372a4ab.js"><link rel="modulepreload" href="/assets/InnoDB 的锁和 MVCC.html-04b051fc.js"><link rel="prefetch" href="/assets/index.html-5e163420.js" as="script"><link rel="prefetch" href="/assets/slides.html-aac21bc7.js" as="script"><link rel="prefetch" href="/assets/index.html-c54caf20.js" as="script"><link rel="prefetch" href="/assets/Canal的原理、配置、实战.html-ff53a293.js" as="script"><link rel="prefetch" href="/assets/使用过程问题总结.html-332b86b5.js" as="script"><link rel="prefetch" href="/assets/实现缓存和数据库一致性方案实战.html-2d037c41.js" as="script"><link rel="prefetch" href="/assets/ES 分片原理.html-067ba1ee.js" as="script"><link rel="prefetch" href="/assets/ES 存储原理.html-aeae0818.js" as="script"><link rel="prefetch" href="/assets/ES 简介及选举机制.html-b8dd5619.js" as="script"><link rel="prefetch" href="/assets/Battle：你会TLAB，我会逃逸分析.html-6aaa7d00.js" as="script"><link rel="prefetch" href="/assets/JVM 之类加载子系统.html-00a62b8c.js" as="script"><link rel="prefetch" href="/assets/JVM 方法区演变过程和内部结构.html-8541cc65.js" as="script"><link rel="prefetch" href="/assets/JVM 核心内存区--堆.html-020f4766.js" as="script"><link rel="prefetch" href="/assets/JVM 运行时数据区.html-3b451057.js" as="script"><link rel="prefetch" href="/assets/JVM 集合之开篇点题.html-11c34521.js" as="script"><link rel="prefetch" href="/assets/JVM集合之开篇点题.html-211fb533.js" as="script"><link rel="prefetch" href="/assets/方法调用的底层原理.html-3390c591.js" as="script"><link rel="prefetch" href="/assets/虚拟机栈5连问，轻松对线面试官.html-8e96cc36.js" as="script"><link rel="prefetch" href="/assets/SecurityJWT 组合拳.html-a678a9fc.js" as="script"><link rel="prefetch" href="/assets/oauth2 之理论-实战-模式-踩坑.html-54ba2fdb.js" as="script"><link rel="prefetch" href="/assets/在 shiro 基础上整合 jwt.html-c422b845.js" as="script"><link rel="prefetch" href="/assets/手把手教你集成 shiro.html-2ceae683.js" as="script"><link rel="prefetch" href="/assets/从常见的存储引擎到混淆的锁分类.html-8cc7b5b7.js" as="script"><link rel="prefetch" href="/assets/数据库架构演变之路.html-9db2ce47.js" as="script"><link rel="prefetch" href="/assets/CentOS8安装 erlang 和 RabbitMQ.html-78debf45.js" as="script"><link rel="prefetch" href="/assets/RabbitMQ 实现超时订单关闭.html-5e0fafee.js" as="script"><link rel="prefetch" href="/assets/SpringBoot 集成 RabbitMQ.html-7346eca0.js" as="script"><link rel="prefetch" href="/assets/CentOs 安装 Redis.html-238fa0bd.js" as="script"><link rel="prefetch" href="/assets/Redis 的主从配置.html-10fc393c.js" as="script"><link rel="prefetch" href="/assets/Redis 的基础配置.html-d2623faf.js" as="script"><link rel="prefetch" href="/assets/Redis 的持久化配置.html-064d51e9.js" as="script"><link rel="prefetch" href="/assets/基于 Redis 实现点赞功能.html-dd2537a8.js" as="script"><link rel="prefetch" href="/assets/基于 Redis 实现附近的人.html-d6d04285.js" as="script"><link rel="prefetch" href="/assets/基于 Redis 实现限流功能.html-1f94bd91.js" as="script"><link rel="prefetch" href="/assets/快速了解 Redis 的概念和命令.html-f3a4383c.js" as="script"><link rel="prefetch" href="/assets/美团二面：细数 Redis 阻塞的9种情况.html-da31c2e8.js" as="script"><link rel="prefetch" href="/assets/index.html-a8f34450.js" as="script"><link rel="prefetch" href="/assets/baz.html-6e50e7ce.js" as="script"><link rel="prefetch" href="/assets/index.html-870260df.js" as="script"><link rel="prefetch" href="/assets/ray.html-20fc63da.js" as="script"><link rel="prefetch" href="/assets/404.html-fca67cc1.js" as="script"><link rel="prefetch" href="/assets/index.html-3484b418.js" as="script"><link rel="prefetch" href="/assets/index.html-e6fe1202.js" as="script"><link rel="prefetch" href="/assets/index.html-3acd0a2d.js" as="script"><link rel="prefetch" href="/assets/index.html-4b15e0d3.js" as="script"><link rel="prefetch" href="/assets/index.html-eff566c2.js" as="script"><link rel="prefetch" href="/assets/index.html-b8769dc4.js" as="script"><link rel="prefetch" href="/assets/index.html-518eb30e.js" as="script"><link rel="prefetch" href="/assets/index.html-543f57be.js" as="script"><link rel="prefetch" href="/assets/index.html-f4f72853.js" as="script"><link rel="prefetch" href="/assets/slides.html-57824e59.js" as="script"><link rel="prefetch" href="/assets/index.html-88faa21b.js" as="script"><link rel="prefetch" href="/assets/Canal的原理、配置、实战.html-31e26147.js" as="script"><link rel="prefetch" href="/assets/使用过程问题总结.html-9bca4f87.js" as="script"><link rel="prefetch" href="/assets/实现缓存和数据库一致性方案实战.html-e31850a4.js" as="script"><link rel="prefetch" href="/assets/ES 分片原理.html-8344da53.js" as="script"><link rel="prefetch" href="/assets/ES 存储原理.html-671c4f80.js" as="script"><link rel="prefetch" href="/assets/ES 简介及选举机制.html-7616e615.js" as="script"><link rel="prefetch" href="/assets/Battle：你会TLAB，我会逃逸分析.html-a82c28f1.js" as="script"><link rel="prefetch" href="/assets/JVM 之类加载子系统.html-a6cda033.js" as="script"><link rel="prefetch" href="/assets/JVM 方法区演变过程和内部结构.html-f909a948.js" as="script"><link rel="prefetch" href="/assets/JVM 核心内存区--堆.html-9aa220ab.js" as="script"><link rel="prefetch" href="/assets/JVM 运行时数据区.html-9d287ebc.js" as="script"><link rel="prefetch" href="/assets/JVM 集合之开篇点题.html-079b7430.js" as="script"><link rel="prefetch" href="/assets/JVM集合之开篇点题.html-8d1870a9.js" as="script"><link rel="prefetch" href="/assets/方法调用的底层原理.html-152a01f8.js" as="script"><link rel="prefetch" href="/assets/虚拟机栈5连问，轻松对线面试官.html-5a09281b.js" as="script"><link rel="prefetch" href="/assets/SecurityJWT 组合拳.html-5c9ead4c.js" as="script"><link rel="prefetch" href="/assets/oauth2 之理论-实战-模式-踩坑.html-de8181e4.js" as="script"><link rel="prefetch" href="/assets/在 shiro 基础上整合 jwt.html-21031233.js" as="script"><link rel="prefetch" href="/assets/手把手教你集成 shiro.html-99789448.js" as="script"><link rel="prefetch" href="/assets/从常见的存储引擎到混淆的锁分类.html-b8d80f29.js" as="script"><link rel="prefetch" href="/assets/数据库架构演变之路.html-797d8d06.js" as="script"><link rel="prefetch" href="/assets/CentOS8安装 erlang 和 RabbitMQ.html-33043a9d.js" as="script"><link rel="prefetch" href="/assets/RabbitMQ 实现超时订单关闭.html-f7d24c69.js" as="script"><link rel="prefetch" href="/assets/SpringBoot 集成 RabbitMQ.html-b476c702.js" as="script"><link rel="prefetch" href="/assets/CentOs 安装 Redis.html-6f0eb58a.js" as="script"><link rel="prefetch" href="/assets/Redis 的主从配置.html-8df1cedf.js" as="script"><link rel="prefetch" href="/assets/Redis 的基础配置.html-ec2bd88b.js" as="script"><link rel="prefetch" href="/assets/Redis 的持久化配置.html-ea61e53d.js" as="script"><link rel="prefetch" href="/assets/基于 Redis 实现点赞功能.html-ce200aa1.js" as="script"><link rel="prefetch" href="/assets/基于 Redis 实现附近的人.html-80c2d293.js" as="script"><link rel="prefetch" href="/assets/基于 Redis 实现限流功能.html-ce5bd3d4.js" as="script"><link rel="prefetch" href="/assets/快速了解 Redis 的概念和命令.html-e659c82c.js" as="script"><link rel="prefetch" href="/assets/美团二面：细数 Redis 阻塞的9种情况.html-6451b9b6.js" as="script"><link rel="prefetch" href="/assets/index.html-2cffb127.js" as="script"><link rel="prefetch" href="/assets/baz.html-d74ffb7d.js" as="script"><link rel="prefetch" href="/assets/index.html-a0331c68.js" as="script"><link rel="prefetch" href="/assets/ray.html-6d19a53d.js" as="script"><link rel="prefetch" href="/assets/404.html-1ff4b837.js" as="script"><link rel="prefetch" href="/assets/index.html-402b8e0f.js" as="script"><link rel="prefetch" href="/assets/index.html-f39b1151.js" as="script"><link rel="prefetch" href="/assets/index.html-8449bd16.js" as="script"><link rel="prefetch" href="/assets/index.html-a6c2643e.js" as="script"><link rel="prefetch" href="/assets/index.html-6a6a061f.js" as="script"><link rel="prefetch" href="/assets/index.html-9ba0e8c9.js" as="script"><link rel="prefetch" href="/assets/index.html-8ffc5474.js" as="script"><link rel="prefetch" href="/assets/index.html-588444d4.js" as="script"><link rel="prefetch" href="/assets/auto-ba5ecab5.js" as="script"><link rel="prefetch" href="/assets/index-b03bef79.js" as="script"><link rel="prefetch" href="/assets/flowchart-35969cab.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-3e591581.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-a794bb63.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-d92a2fc9.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-224f94d9.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-e5069ce0.js" as="script"><link rel="prefetch" href="/assets/search.esm-2c3fba7d.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-d85deb36.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-36cd6c3c.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.jpg" alt="阿Q说代码"><!----><span class="site-name hide-in-pad">阿Q说代码</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="主页"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/cheetah/" class="nav-link active" aria-label="文章"><span class="font-icon icon iconfont icon-discover" style=""></span>文章<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://gitee.com/zhangxiaoQ" rel="noopener noreferrer" target="_blank" aria-label="Gitee" class="nav-link"><span class="font-icon icon iconfont icon-gitee" style=""></span>Gitee<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/ZhangXiaoQ" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/" class="nav-link sidebar-link sidebar-page" aria-label="主页"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-storage" style=""></span><a href="/cheetah/jvm" class="title">JVM</a><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-mysql" style=""></span><a href="/cheetah/mysql" class="title">MySQL</a><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="InnoDB 的锁和 MVCC"><span class="font-icon icon iconfont icon-mysql" style=""></span>InnoDB 的锁和 MVCC<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#事务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="事务"><!---->事务<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#概念" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="概念"><!---->概念<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#事务的特性-acid" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="事务的特性：ACID"><!---->事务的特性：ACID<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#事务的操作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="事务的操作"><!---->事务的操作<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#隔离性引发的并发问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="隔离性引发的并发问题"><!---->隔离性引发的并发问题<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#事务的隔离级别" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="事务的隔离级别"><!---->事务的隔离级别<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#lbcc-mvcc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="LBCC &amp; MVCC"><!---->LBCC &amp; MVCC<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#lbcc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="LBCC"><!---->LBCC<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#mvcc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="MVCC"><!---->MVCC<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/cheetah/mysql/%E4%BB%8E%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%88%B0%E6%B7%B7%E6%B7%86%E7%9A%84%E9%94%81%E5%88%86%E7%B1%BB.html" class="nav-link sidebar-link sidebar-page" aria-label="从常见的存储引擎到混淆的锁分类"><span class="font-icon icon iconfont icon-mysql" style=""></span>从常见的存储引擎到混淆的锁分类<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/cheetah/mysql/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98%E4%B9%8B%E8%B7%AF.html" class="nav-link sidebar-link sidebar-page" aria-label="数据库架构演变之路"><span class="font-icon icon iconfont icon-mysql" style=""></span>数据库架构演变之路<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-workingDirectory" style=""></span><a href="/cheetah/redis" class="title">Redis</a><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-line" style=""></span><a href="/cheetah/rabbitmq" class="title">RabbitMQ</a><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-autumn" style=""></span><a href="/cheetah/es" class="title">ElasticSearch</a><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-change" style=""></span><a href="/cheetah/canal" class="title">canal</a><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-lock" style=""></span><a href="/cheetah/lock" class="title">身份、权限认证</a><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="font-icon icon iconfont icon-mysql" style=""></span>InnoDB 的锁和 MVCC</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://mp.weixin.qq.com/mp/profile_ext?action=home&amp;__biz=MzI5MDg2NjEzNA==#wechat_redirect" target="_blank" rel="noopener noreferrer">阿Q</a></span><span property="author" content="阿Q"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-04-04T01:24:17.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 19 分钟</span><meta property="timeRequired" content="PT19M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category4" role>mysql</span><meta property="articleSection" content="mysql"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag0" role>事务</span><span class="page-tag-item tag1" role>LBCC</span><span class="page-tag-item tag8" role>MVCC</span><meta property="keywords" content="事务,LBCC,MVCC"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#事务" class="router-link-active router-link-exact-active toc-link level2">事务</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#概念" class="router-link-active router-link-exact-active toc-link level3">概念</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#事务的特性-acid" class="router-link-active router-link-exact-active toc-link level3">事务的特性：ACID</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#事务的操作" class="router-link-active router-link-exact-active toc-link level3">事务的操作</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#隔离性引发的并发问题" class="router-link-active router-link-exact-active toc-link level3">隔离性引发的并发问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#事务的隔离级别" class="router-link-active router-link-exact-active toc-link level3">事务的隔离级别</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#lbcc-mvcc" class="router-link-active router-link-exact-active toc-link level2">LBCC &amp; MVCC</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#lbcc" class="router-link-active router-link-exact-active toc-link level3">LBCC</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cheetah/mysql/InnoDB%20%E7%9A%84%E9%94%81%E5%92%8C%20MVCC.html#mvcc" class="router-link-active router-link-exact-active toc-link level3">MVCC</a></li><!----><!--]--></ul></li><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>最近要在公司内做一次技术分享，思来想去不知道该分享些什么，最后在朋友的提示下，准备分享一下<code>MySQL</code>的<code>InnoDB</code>引擎下的事务幻读问题与解决方案--<code>LBCC</code>&amp;<code>MVCC</code>。经过好几天的熬夜通宵，终于把这部分的内容捋清楚了。至于为什么说是<code>InnoDB</code>呢？因为<code>MyISAM</code>引擎是不支持事务的。</p><h2 id="事务" tabindex="-1"><a class="header-anchor" href="#事务" aria-hidden="true">#</a> 事务</h2><h3 id="概念" tabindex="-1"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h3><p>一个事情由n个单元组成，这n个单元在执行过程中，要么同时成功，要么同时失败，这就把n个单元放在了一个事务之中。举个简单的例子：在不考虑试题正确与否的前提下，一张试卷由多个题目构成，当你答完题交给老师的时候是将一整张试卷交给老师，而不是将每道题单独交给老师，在这里试卷就可以理解成一个事务。</p><h3 id="事务的特性-acid" tabindex="-1"><a class="header-anchor" href="#事务的特性-acid" aria-hidden="true">#</a> 事务的特性：ACID</h3><p>A：原子性（<code>Atomicity</code>），原子性是指事务是一个不可分割的工作单位，事务中的操作，要么都发生，要么都不发生。</p><p><strong>例</strong>：假设你在购物车里添加了两件衣服：上衣和裤子，当你把两件衣服作为一个订单提交支付的时候，要么两件衣服一起支付成功，要么都失败，不可能存在上衣付完钱了，裤子还没付完的情况，反之亦然。</p><p>C：一致性（<code>Consistency</code>），在一个事务中，事务前后数据的完整性必须保持一致。</p><p><strong>例</strong>：假设用户A和用户B两者的钱加起来一共是200，那么不管A和B之间如何转账，转几次账，事务结束后两个用户的钱相加起来应该还得是200，这就是事务的一致性。</p><p>I：隔离性（<code>Isolation</code>），存在于多个事务中，事务的隔离性是指多个用户并发访问数据库时，一个用户的事务不能被其它用户的事务所干扰，多个并发事务之间数据要相互隔离。</p><p><strong>例</strong>：对于任意两个并发的事务T1和T2，在事务T1看来，T2要么在T1开始之前就已经结束，要么在T1结束之后才开始，这样每个事务都感觉不到有其他事务在并发地执行。</p><p>D：持久性（<code>Durability</code>），持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来即使数据库发生故障也不应该对其有任何影响。</p><p><strong>例</strong>：我们在操作数据库时，事务提交或者回滚都会直接改变数据库中的值。</p><h3 id="事务的操作" tabindex="-1"><a class="header-anchor" href="#事务的操作" aria-hidden="true">#</a> 事务的操作</h3><p>在使用事务之前，首先我们要开启事务，我们可以通过<code>start</code>或者<code>begin</code>命令开启事务；如果我们想提交事务可以手动执行<code>commit</code>命令，如果我们想回滚事务，可以执行<code>rollback</code>命令。</p><p>注：在<code>MySQL</code>中事务的提交是默认开启的，可以执行<code>show variables like &#39;autocommit&#39;</code>命令查看，如果是<code>ON</code>则证明自动提交已经开启，如果为<code>OFF</code>则需要手动提交。</p><h3 id="隔离性引发的并发问题" tabindex="-1"><a class="header-anchor" href="#隔离性引发的并发问题" aria-hidden="true">#</a> 隔离性引发的并发问题</h3><p>1）脏读：B事务读取到了A事务尚未提交的数据；</p><p>2）不可重复读：B事务读到了A事务已经提交的数据，即B事务在A事务提交之前和提交之后读取到的数据<code>内容</code>不一致（AB事务操作的是同一条数据）；</p><p>3）幻读/虚读：B事务读到了A事务已经提交的数据，即A事务执行插入操作，B事务在A事务前后读到的数据<code>数量</code>不一致。</p><h3 id="事务的隔离级别" tabindex="-1"><a class="header-anchor" href="#事务的隔离级别" aria-hidden="true">#</a> 事务的隔离级别</h3><p>为了解决以上隔离性引发的并发问题，数据库提供了事物的隔离机制。</p><ul><li>read uncommitted（读未提交）: 一个事务还没提交时，它做的变更就能被别的事务看到，读取尚未提交的数据，哪个问题都不能解决；</li><li>read committed（读已提交）：一个事务提交之后，它做的变更才会被其他事务看到，读取已经提交的数据，可以解决脏读 ---- <code>oracle</code>默认的；</li><li>repeatable read（可重复读）：一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的，可以解决脏读和不可重复读 ---<code>mysql</code>默认的；</li><li>serializable（串行化）：顾名思义是对于同一行记录，“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行。可以解决脏读、不可重复读和虚读---相当于锁表。</li></ul><p>虽然<code>serializable</code>级别可以解决所有的数据库并发问题，但是它会在读取的每一行数据上都加锁，这就可能导致大量的超时和锁竞争问题，从而导致效率下降。所以我们在实际应用中也很少使用<code>serializable</code>，只有在非常需要确保数据的一致性而且可以接受没有并发的情况下，才考虑采用该级别。</p><h2 id="lbcc-mvcc" tabindex="-1"><a class="header-anchor" href="#lbcc-mvcc" aria-hidden="true">#</a> LBCC &amp; MVCC</h2><p><code>InnoDB</code>默认的事务隔离级别是<code>repeatable read</code>（后文中用简称RR），它为了解决该隔离级别下的幻读的并发问题，提出了<code>LBCC</code>和<code>MVCC</code>两种方案。其中<code>LBCC</code>解决的是当前读情况下的幻读，<code>MVCC</code>解决的是普通读（快照读）的幻读。至于什么是当前读，什么是快照读，将在下文中给出答案。</p><h3 id="lbcc" tabindex="-1"><a class="header-anchor" href="#lbcc" aria-hidden="true">#</a> LBCC</h3><p><code>LBCC</code>是<code>Lock-Based Concurrent Control</code>的简称，意思是基于锁的并发控制。在<code>InnoDB</code>中按锁的模式来分的话可以分为共享锁（S）、排它锁（X）和意向锁，其中意向锁又分为意向共享锁（IS）和意向排它锁（IX）（此处先不做介绍，后期会专门出篇文章讲一下<code>InnoDB</code>和<code>Myisam</code>引擎的锁）；如果按照锁的算法来分的话又分为记录锁（<code>Record Locks</code>）、间隙锁（<code>Gap Locks</code>）和临键锁（<code>Next-key Locks</code>）。其中临键锁就可以用来解决RR下的幻读问题。那么什么是临键锁呢？继续往下看。</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/25a6b3d786d94641afb6e9ec356f1f55~tplv-k3u1fbpfcp-zoom-1.image" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>我们将数据库中存储的每一行数据称为记录。则上图中1、5、9、11分别代表id为当前数的记录。对于键值在条件范围内但不存在的记录，叫做间隙（GAP）。则上图中的（-∞，1）、（1，5）...（11，+∞）为数据库中存在的间隙。而（-∞，1]、（1，5]...（11，+∞）我们称之为临键，即左开右闭的集合。</p><h4 id="记录锁-record-locks" tabindex="-1"><a class="header-anchor" href="#记录锁-record-locks" aria-hidden="true">#</a> 记录锁（Record Locks）</h4><p>对表中的行记录加锁，叫做记录锁，简称行锁。可以使用<code>sql</code>语句<code>select ... for update</code>来开启锁，<code>select</code>语句必须为精准匹配（=），不能为范围匹配，且匹配列字段必须为唯一索引或者主键列。也可以通过对查询条件为主键索引或唯一索引的数据行进行<code>UPDATE</code>操作来添加记录锁。</p><blockquote><p>记录锁存在于包括主键索引在内的唯一索引中，锁定单条索引记录。</p></blockquote><h4 id="间隙锁-gap-locks" tabindex="-1"><a class="header-anchor" href="#间隙锁-gap-locks" aria-hidden="true">#</a> 间隙锁（GAP Locks）</h4><p>对上面说到的间隙加锁即为间隙锁。间隙锁是对范围加锁，但不包括已存在的索引项。可以使用<code>sql</code>语句<code>select ... for update</code>来开启锁，<code>select</code>语句为范围查询，匹配列字段为索引项，且没有数据返回；或者<code>select</code>语句为等值查询，匹配字段为唯一索引，也没有数据返回。</p><p>间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害。以下是加锁之后，插入操作的例子：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>select <span class="token operator">*</span> from user where id <span class="token operator">&gt;</span> <span class="token number">15</span> <span class="token keyword">for</span> update<span class="token punctuation">;</span>
<span class="token comment">//插入失败，因为id20大于15，不难理解</span>
insert into user <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token char">&#39;20&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//插入失败，原因是间隙锁锁的是记录间隙，而不是sql，也就是说`select`语句的锁范围是（11，+∞），而13在这个区间中，所以也失败。</span>
insert into user <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token char">&#39;13&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>GAP Locks</code>只存在于RR隔离级别下，它锁住的是间隙内的数据。加完锁之后，间隙中无法插入其他记录，并且锁的是记录间隙，而非<code>sql</code>语句。间隙锁之间都不存在冲突关系。</p></blockquote><p><strong>打开间隙锁设置：</strong> 以通过命令<code>show variables like &#39;innodb_locks_unsafe_for_binlog&#39;;</code>来查看 <code>innodb_locks_unsafe_for_binlog</code> 是否禁用。<code>innodb_locks_unsafe_for_binlog</code>默认值为OFF，即启用间隙锁。因为此参数是只读模式，如果想要禁用间隙锁，需要修改 <code>my.cnf</code>（windows是<code>my.ini</code>） 重新启动才行。</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#在 my.cnf 里面的[mysqld]添加</span>
[mysqld]
<span class="token key attr-name">innodb_locks_unsafe_for_binlog</span> <span class="token punctuation">=</span> <span class="token value attr-value">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="临键锁-next-key-locks" tabindex="-1"><a class="header-anchor" href="#临键锁-next-key-locks" aria-hidden="true">#</a> 临键锁（Next-Key Locks）</h4><p>当我们对上面的记录和间隙共同加锁时，添加的便是临键锁（左开右闭的集合加锁）。为了防止幻读，临键锁阻止特定条件的新记录的插入，因为插入时要获取插入意向锁，与已持有的临键锁冲突。可以使用<code>sql</code>语句<code>select ... for update</code>来开启锁，<code>select</code>语句为范围查询，匹配列字段为索引项，且有数据返回；或者<code>select</code>语句为等值查询，匹配列字段为索引项，不管有没有数据返回。</p><blockquote><p>插入意向锁并非意向锁，而是一种特殊的间隙锁。</p></blockquote><h4 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h4><ul><li>如果查询没有命中索引，则退化为表锁;</li><li>如果等值查询唯一索引且命中唯一一条记录，则退化为行锁;</li><li>如果等值查询唯一索引且没有命中记录，则退化为临近结点的间隙锁;</li><li>如果等值查询非唯一索引且没有命中记录，退化为临近结点的间隙锁(包括结点也被锁定)；如果命中记录，则锁定所有命中行的临键锁，并同时锁定最大记录行下一个区间的间隙锁。</li><li>如果范围查询唯一索引或查询非唯一索引且命中记录，则锁定所有命中行的临键锁 ，并同时锁定最大记录行下一个区间的间隙锁。</li><li>如果范围查询索引且没有命中记录，退化为临近结点的间隙锁(包括结点也被锁定)。</li></ul><h4 id="当前读" tabindex="-1"><a class="header-anchor" href="#当前读" aria-hidden="true">#</a> 当前读</h4><p>当前读（<code>Locking Read</code>）也称锁定读，读取当前数据的最新版本，而且读取到这个数据之后会对这个数据加锁，防止别的事务更改即通过<code>next-key</code>锁（行锁+gap锁）来解决当前读的问题。在进行写操作的时候就需要进行“当前读”，读取数据记录的最新版本，包含以下<code>SQL</code>类型：<code>select ... lock in share mode</code> 、<code>select ... for update</code>、<code>update</code> 、<code>delete</code> 、<code>insert</code>。</p><h3 id="mvcc" tabindex="-1"><a class="header-anchor" href="#mvcc" aria-hidden="true">#</a> MVCC</h3><p><code>LBCC</code>是基于锁的并发控制，因为锁的粒度过大，会导致性能的下降，因此提出了比<code>LBCC</code>性能更优越的方法<code>MVCC</code>。<code>MVCC</code>是<code>Multi-Version Concurremt Control</code>的简称，意思是基于多版本的并发控制协议，通过版本号，避免同一数据在不同事务间的竞争，只存在于<code>InnoDB</code>引擎下。它主要是为了提高数据库的并发读写性能，不用加锁就能让多个事务并发读写。<code>MVCC</code>的实现依赖于：三个隐藏字段、<code>Undo log</code>和<code>Read View</code>，其核心思想就是：只能查找事务id小于等于当前事务ID的行；只能查找删除时间大于等于当前事务ID的行，或未删除的行。接下来让我们从源码级别来分析下<code>MVCC</code>。</p><h4 id="隐藏列" tabindex="-1"><a class="header-anchor" href="#隐藏列" aria-hidden="true">#</a> 隐藏列</h4><p><code>MySQL</code>中会为每一行记录生成隐藏列，接下来就让我们了解一下这几个隐藏列吧。</p><p>（1）DB_TRX_ID：事务ID，是根据事务产生时间顺序自动递增的，是独一无二的。如果某个事务执行过程中对该记录执行了增、删、改操作，那么<code>InnoDB</code>存储引擎就会记录下该条事务的id。</p><p>（2）DB_ROLL_PTR：回滚指针，本质上就是一个指向记录对应的<code>undo log</code>的一个指针，大小为 7 个字节，<code>InnoDB</code> 便是通过这个指针找到之前版本的数据。该行记录上所有旧版本，在<code>undo log</code>中都通过链表的形式组织。</p><p>（3）DB_ROW_ID：行标识（隐藏单调自增 <code>ID</code>），如果表没有主键，InnoDB 会自动生成一个隐藏主键，大小为 6 字节。如果数据表没有设置主键，会以它产生聚簇索引。</p><p>（4）实际还有一个删除flag隐藏字段，既记录被更新或删除并不代表真的删除，而是删除flag变了。</p><h4 id="undo-log" tabindex="-1"><a class="header-anchor" href="#undo-log" aria-hidden="true">#</a> undo log</h4><p>每当我们要对一条记录做改动时（这里的改动可以指INSERT、DELETE、UPDATE），都需要把回滚时所需的东西记录下来, 比如:</p><ul><li>Insert undo log ：插入一条记录时，至少要把这条记录的主键值记下来，之后回滚的时候只需要把这个主键值对应的记录删掉就好了。</li><li>Delete undo log：删除一条记录时，至少要把这条记录中的内容都记下来，这样之后回滚时再把由这些内容组成的记录插入到表中就好了。</li><li>Update undo log：修改一条记录时，至少要把修改这条记录前的旧值都记录下来，这样之后回滚时再把这条记录更新为旧值就好了。 <code>InnoDB</code>把这些为了回滚而记录的这些东西称之为<code>undo log</code>。这里需要注意的一点是，由于查询操作（<code>SELECT</code>）并不会修改任何用户记录，所以在查询操作执行时，并不需要记录相应的<code>undo log</code>。</li></ul><p>每次对记录进行改动都会记录一条undo日志，每条undo日志也都有一个<code>DB_ROLL_PTR</code>属性，可以将这些undo日志都连起来，串成一个链表，形成版本链。版本链的头节点就是当前记录最新的值。</p><p><strong>例</strong></p><p>先插入一条记录，假设该记录的事务id为80，那么此刻该条记录的示意图如下所示</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44f1d247672146209c927321bf3dca65~tplv-k3u1fbpfcp-zoom-1.image" alt="sql插入" tabindex="0" loading="lazy"><figcaption>sql插入</figcaption></figure><p>实际上<code>insert undo</code>只在事务回滚时起作用，当事务提交后，该类型的undo日志就没用了，它占用的<code>Undo Log Segment</code>也会被系统回收。接着继续执行sql操作</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e9b8469b01da4ee1851233ea22fcf2c1~tplv-k3u1fbpfcp-zoom-1.image" alt="sql更新" tabindex="0" loading="lazy"><figcaption>sql更新</figcaption></figure><p>其版本链如下</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40a9af4008e64e9abc5349260cee652e~tplv-k3u1fbpfcp-zoom-1.image" alt="版本链" tabindex="0" loading="lazy"><figcaption>版本链</figcaption></figure><blockquote><p>很多人以为<code>undo log</code>用于将数据库物理的恢复到执行语句或者事务之前的样子，其实并非如此，<code>undo log</code>是逻辑日志，只是将数据库逻辑的恢复到原来的样子。因为在多并发系统中，你把一个页中的数据物理的恢复到原来的样子，可能会影响其他的事务。</p></blockquote><h4 id="read-view" tabindex="-1"><a class="header-anchor" href="#read-view" aria-hidden="true">#</a> Read View</h4><p>在可重复读隔离级别下，我们可以把每一次普通的<code>select</code>查询（不加<code>for update</code>语句）当作一次快照读，而快照便是进行<code>select</code>的那一刻，生成的当前数据库系统中所有未提交的事务id数组（数组里最小的<code>id</code>为<code>min_id</code>）和已经创建的最大事务<code>id</code>（<code>max_id</code>）的集合，即我们所说的一致性视图<code>readview</code>。在进行快照读的过程中要根据一定的规则将版本链中每个版本的事务<code>id</code>与<code>readview</code>进行匹配查询我们需要的结果。</p><p>快照读是不会看到别的事务插入的数据的。因此，幻读在“当前读”下才会出现。快照读的实现是基于多版本并发控制，即<code>MVCC</code>，可以认为<code>MVCC</code>是行锁的一个变种，但它在很多情况下，避免了加锁操作，降低了开销；既然是基于多版本，即快照读可能读到的并不一定是数据的最新版本，而有可能是之前的历史版本。<code>MVCC</code>只在 <code>READ COMMITTED</code> 和 <code>REPEATABLE READ</code>两个隔离级别下工作，其他两个隔离级别不和<code>MVCC</code>不兼容。因为<code>READ UNCOMMITTED</code>总是读取最新的数据行，而不是符合当前事务版本的数据行，而<code>SERIALIZABLE</code> 则会对所有读取的行都加锁。事务的快照时间点（即下文中说到的<code>Read View</code>的生成时间）是以第一个<code>select</code>来确认的。所以即便事务先开始，但是<code>select</code>在后面的事务的<code>update</code>之类的语句后进行，那么它是可以获取前面的事务的对应的数据。</p><blockquote><p>RC和RR隔离级别下的快照读和当前读：RC隔离级别下，快照读和当前读结果一样，都是读取已提交的最新；RR隔离级别下，当前读结果是其他事务已经提交的最新结果，快照读是读当前事务之前读到的结果。RR下创建快照读的时机决定了读到的版本。</p></blockquote><p>对于使用RC和RR隔离级别的事务来说，都必须保证读到已经提交了的事务修改过的记录，也就是说假如另一个事务已经修改了记录但是尚未提交，是不能直接读取最新版本的记录的。核心问题就是：需要判断一下版本链中的哪个版本是当前事务可见的。为此，<code>InnoDB</code>提出了一个<code>Read View</code>的概念。</p><p><code>Read View</code>就是事务进行快照读（普通<code>select</code>查询）操作的时候生产的一致性读视图，在该事务执行的快照读的那一刻，会生成数据库系统当前的一个快照，它由执行查询时所有未提交的事务id数组（数组里最小的id为<code>min_id</code>）和已经创建的最大事务id（<code>max_id</code>）组成，查询的数据结果需要跟<code>read view</code>做对比从而得到快照结果。</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d57e66b89e5b4221a05e5c12ca696165~tplv-k3u1fbpfcp-zoom-1.image" alt="快照规则" tabindex="0" loading="lazy"><figcaption>快照规则</figcaption></figure><p><strong>版本链比对规则：</strong></p><ol><li>如果落在绿色部分（trx_id&lt;min_id），表示这个版本是已经提交的事务生成的，这个数据是可见的；</li><li>如果落在红色部分（trx_id&gt;max_id），表示这个版本是由将来启动的事务生成的，是肯定不可见的；</li><li>如果落在黄色部分（min_id&lt;=trx_id&lt;=max_id），那就包含两种情况： a.若row的trx_id在数组中，表示这个版本是由还没提交的事务生成的，不可见；如果是自己的事务，则是可见的； b.若row的trx_id不在数组中，表示这个版本是已经提交了的事务生成的，可见。</li></ol><p>光说不练假把式，接下来就让我们用例子来演示一下：首先我们要准备两张表，一张<code>test</code>和一张<code>account</code>表，然后我们以<code>account</code>的<code>undo log</code>来画版本链，准备数据和原始记录图如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//test表中数据</span>
id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>c1<span class="token operator">=</span><span class="token char">&#39;11&#39;</span><span class="token punctuation">;</span>
id<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>c1<span class="token operator">=</span><span class="token char">&#39;22&#39;</span><span class="token punctuation">;</span>
<span class="token comment">//account表数据</span>
id<span class="token operator">=</span><span class="token number">1</span>，name<span class="token operator">=</span>‘lilei’；
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bbebd14c24984ec68d3be6f525e2c61d~tplv-k3u1fbpfcp-zoom-1.image" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>如下图，我们将按照里面的顺序执行<code>sql</code></p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c35fb5dc765148cfb30227142fce4367~tplv-k3u1fbpfcp-zoom-1.image" alt="RR模式下多个事务执行" tabindex="0" loading="lazy"><figcaption>RR模式下多个事务执行</figcaption></figure><p>当我们执行到第7行的<code>select</code>的语句时，会生成<code>readview[100,200],300</code>,版本链如图所示：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4940c8b7884241bcb8079c33e9df2bc7~tplv-k3u1fbpfcp-zoom-1.image" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此时我们查询到的数据为<code>lilei300</code>。我们首先要拿最新版本的数据<code>trx_id=300</code>来<code>readview</code>中匹配，落在黄色区间内，一看该数据已经提交了，所以是可见的。继续往下执行，当执行到第10行的<code>select</code>语句时，因为<code>trx_id=100</code>并未提交，所以版本链依然为<code>readview[100,200],300</code>，版本链如图所示：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f0ac0dcf53b47379dae4c7e76e88b0c~tplv-k3u1fbpfcp-zoom-1.image" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此时我们查询到的数据为<code>lilei300</code>。我们按上边操作，从最新版本依次往下匹配，我们首先要拿最新版本的数据<code>trx_id=100</code>来<code>readview</code>中匹配，落在黄色区间内，一看该数据在未提交的数组中，且不是自己的事务，所以是不可见的；然后我们选择前一个版本的数据，结果同上；继续向上找，当找到<code>trx_id=300</code>的数据时，会落在黄色区间，且是提交的，所以数据可见。继续往下执行，当执行到第13行的<code>select</code>语句时，此时尽管<code>trx_id=100</code>已经提交了，因为是<code>InnoDB</code>的RR模式，所以<code>readview</code>不会更改，仍为<code>readview[100,200],300</code>,版本链如图所示：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c8412e46839a4552acad30ec773afb6a~tplv-k3u1fbpfcp-zoom-1.image" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此时我们查询到的数据为<code>lilei300</code>。原因同上边的步骤，不再赘述。</p><blockquote><p>当执行<code>update</code>语句时，都是先读后写的，而这个读，是当前读，只能读当前的值，跟<code>readview</code>查找时的快照读区分开。</p></blockquote><p>刚才演示的是<code>InnoDB</code>下的RR模式，接下来我们简单说一下RC模式，上文中提到的RC模式的数据读都是读最新的即当前读，所以readview是实时生成的，执行语句如图所示：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5667b69b2b394ef8a0d38d9aadc63a1c~tplv-k3u1fbpfcp-zoom-1.image" alt="RC模式下多事务执行" tabindex="0" loading="lazy"><figcaption>RC模式下多事务执行</figcaption></figure><p>当我们执行到第13行的<code>select</code>的语句时，会生成<code>readview[200],300</code>，版本链还和之前一样，此时我们查询到的数据为<code>lilei2</code>。原因和上边讲的RR模式下的比对规则相同。</p><p>此处我们演示的是<code>update</code>的情况，对于删除的情况可以认为是<code>update</code>的特殊情况，会将版本链上最新的数据复制一份，然后将<code>trx_id</code>改成删除操作的<code>trx_id</code>，同时在该条记录的头信息（<code>record header</code>）里的（<code>deleted_flag</code>）标记位上写上<code>true</code>，来表示当前记录已经被删除，在查询时按照上边的规则查到对应的记录，如果<code>delete_flag</code>标记位为<code>true</code>，意味着记录已被删除，则不返回数据。</p><p>大家应该还关心一个问题，即<code>undo log</code>什么时候删除呢？系统会判断，没有比这个<code>undo log</code>更早的<code>read view</code>的时候，<code>undo log</code>会被删除。所以这里也就是为什么我们建议你尽量不要使用长事务的原因。长事务意味着系统里面会存在很老的事务视图。由于这些事务随时可能访问数据库里面的任何数据，所以这个事务提交之前，数据库里面它可能用到的回滚记录都必须保留，这就会导致大量占用存储空间。</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/ZhangXiaoQ/edit/main/demo/theme-docs/src/cheetah/mysql/InnoDB 的锁和 MVCC.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1004387130@qq.com">ZhangXiaoQ</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><!----><a href="/cheetah/mysql/%E4%BB%8E%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%88%B0%E6%B7%B7%E6%B7%86%E7%9A%84%E9%94%81%E5%88%86%E7%B1%BB.html" class="nav-link next" aria-label="从常见的存储引擎到混淆的锁分类"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">从常见的存储引擎到混淆的锁分类<span class="font-icon icon iconfont icon-mysql" style=""></span></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">联系阿Q：qingqing-4132</div><div class="copyright">Copyright © 2023 阿Q</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-9ac075de.js" defer></script>
  </body>
</html>
